# 后端服务负载均衡配置
upstream backend_servers_group_buy_market {
    server 117.72.221.253:8091;
    server 117.72.221.253:8092;
}

upstream backend_servers_s_pay_mall {
    server 117.72.221.253:9091;
}

# API后端服务 - HTTP转HTTPS
server {
    listen 80;
    listen [::]:80;
    server_name api.zkyhwx.top;  # 后端API域名

    # 强制HTTPS
    rewrite ^(.*) https://$server_name$1 permanent;
}

# API后端服务 - HTTPS配置
server {
    listen 443 ssl;
    server_name api.zkyhwx.top;  # 后端API域名

    # SSL证书配置
    ssl_certificate      /etc/nginx/ssl/_.zkyhwx.top.pem;
    ssl_certificate_key  /etc/nginx/ssl/_.zkyhwx.top.key;

    # SSL优化配置
    ssl_session_cache    shared:SSL:1m;
    ssl_session_timeout  5m;
    ssl_ciphers  HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers  on;

    # 后端API接口代理
    location /api/v1/gbm/ {
        proxy_pass http://backend_servers_group_buy_market;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /api/v1/alipay/ {
        proxy_pass http://backend_servers_s_pay_mall;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /api/v1/login/ {
        proxy_pass http://backend_servers_s_pay_mall;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /api/v1/weixin/ {
        proxy_pass http://backend_servers_s_pay_mall;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 错误页面配置
    error_page   500 502 503 504  /50x.html;
    location = /50x.html {
        root   /usr/share/nginx/html;
    }
}

# 前端服务 - HTTP转HTTPS
server {
    listen 80;
    listen [::]:80;
    server_name front.zkyhwx.top;  # 前端域名

    # 强制HTTPS
    rewrite ^(.*) https://$server_name$1 permanent;
}

# 前端服务 - HTTPS配置
server {
    listen 443 ssl;
    server_name front.zkyhwx.top;  # 前端域名

    # SSL证书配置（与API共用通配符证书）
    ssl_certificate      /etc/nginx/ssl/_.zkyhwx.top.pem;
    ssl_certificate_key  /etc/nginx/ssl/_.zkyhwx.top.key;

    # SSL优化配置
    ssl_session_cache    shared:SSL:1m;
    ssl_session_timeout  5m;
    ssl_ciphers  HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers  on;

    # 前端静态文件配置
    location / {
        root   /usr/share/nginx/html;  # 前端文件存放目录
        index  index.html index.htm;
        try_files $uri $uri/ /index.html;  # 支持前端路由跳转
        proxy_set_header   X-Real-IP         $remote_addr;
        proxy_set_header   Host              $http_host;
        proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
    }

    # 错误页面配置
    error_page   500 502 503 504  /50x.html;
    location = /50x.html {
        root   /usr/share/nginx/html;
    }
}
